#!/bin/bash
set -e

#todo check to see if rsyslog/logrotate is installed before moving over config files

utilsDir="/opt/utilities"
wifi_module_chk=`shasum /lib/modules/3.2.18-psp14/kernel/drivers/net/wireless/8192cu.ko | cut -f1 -d' '`


if [ -f /etc/environment.local ]; then
    . /etc/environment.local
fi

echo "[System] `date` System Update Script Started (${NINJA_ENV:-"stable"})" >> /var/log/ninjablock.log


cp ${utilsDir}/etc/hostname /etc/
hostname ninjablock
cp ${utilsDir}/etc/hosts /etc/
cp ${utilsDir}/etc/network/interfaces /etc/network/



if [ -d /etc/init ]
then
	cp ${utilsDir}/init/dmesg.conf /etc/init/
fi

if [ -d /etc/update-motd.d/ ]
then
	cp ${utilsDir}/etc/update-motd.d/10-help-text /etc/update-motd.d/
	cp ${utilsDir}/etc/update-motd.d/99-footer /etc/update-motd.d/
fi

cp ${utilsDir}/etc/modprobe.d/8192cu.conf /etc/modprobe.d/
cp ${utilsDir}/etc/default/ifplugd /etc/default/

if [ -f /etc/motd.tail ]
then
	rm /etc/motd.tail
fi

if [ -d /etc/cron.daily ]
then
    mv /etc/cron.daily/logrotate /etc/cron.hourly
fi



if [[ "$wifi_module_chk" != "4074aa90269a4cc0ad136a7dc93ef4b3fc65a2d3" ]] 
then
	echo "Upgrade wifi module" >> /var/log/ninjablock.log
	cp ${utilsDir}/wifi-driver/8192cu.ko /lib/modules/`uname -r`/kernel/drivers/net/wireless/
fi

if [[ -f /etc/opt/ninja/.has_updated_software ]]
then
	rm /etc/opt/ninja/.has_updated_software
fi

grep ninja_install_software /etc/rc.loca1

if [[ $? -ne 0 ]]
then
        sed -i 's:^exit 0$:/opt/utilities/bin/ninja_install_software\nexit 0:' /etc/rc.local
fi

echo '0.6' > ${utilsDir}/sys_version
touch /etc/opt/ninja/.has_updated_system
reboot
