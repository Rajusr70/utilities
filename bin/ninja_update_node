#!/bin/bash
# Define directories
code_dir=/opt/ninja
util_dir=/opt/utilities
tmp_dir=$util_dir/tmp
if [ -f /etc/opt/ninja/.has_updated_node ]; then
	exit 1
fi
touch /etc/opt/ninja/.has_updated_node
# Pull new code from repo
cd $tmp_dir
curl --output node.tar.gz http://s3.amazonaws.com/ninjablocks/code/beagle/node/${NINJA_ENV:-"stable"}.tar.gz
remote_checksum=$(curl http://s3.amazonaws.com/ninjablocks/code/beagle/node/${NINJA_ENV:-"stable"}.checksum | awk '{ print $1 }')
local_checksum=$(sha1sum node.tar.gz | awk '{ print $1 }')
if [ "$remote_checksum"="$local_checksum" ]; then
	echo "[System] Updating Node" >> /var/log/ninjablock.log
	tar -zxf node.tar.gz
	rm -rf $code_dir/*
	cp -Rf ninja/* $code_dir/
	rm node.tar.gz
	rm -rf ninja
	exit 0
else
	echo "[System] Invalid Node Checksum" >> /var/log/ninjablock.log
	rm node.tar.gz
	exit 1
fi