#!/bin/bash
# Define directories
code_dir=/opt/ninja
util_dir=/opt/utilities
tmp_dir=$util_dir/tmp
cd $tmp_dir
wget -O --read-timeout=120 utilities.tar.gz https://s3.amazonaws.com/ninjablocks/code/beagle/utilities/${NINJA_ENV:-"stable"}.tar.gz
remote_checksum=$(wget https://s3.amazonaws.com/ninjablocks/code/beagle/utilities/${NINJA_ENV:-"stable"}.checksum -q -O -)
local_checksum=$(sha1sum utilities.tar.gz | awk '{ print $1 }')
if [ "$remote_checksum"="$local_checksum" ]; then
	echo "[System] Updating Utilities" >> /var/log/ninjablock.log
	tar -zxf utilities.tar.gz
	cp -Rf utilities/* $util_dir/
	cp -Rf $util_dir/init/* /etc/init/
	chown ubuntu:ubuntu $util_dir/bin/ninja_update_node
	rm utilities.tar.gz
	rm -rf utilities
	exit 0
else
	echo "[System] Invalid Utilities Checksum" >> /var/log/ninjablock.log
	rm utilities.tar.gz
	exit 1
fi